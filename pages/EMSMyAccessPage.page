<apex:page controller="EMSHomeCntrl" extensions="ExternalRequestCntrl" showHeader="false" sidebar="false" action="{!redir}" standardStylesheets="false" title="EMS | My Apps/Request Access">
    <head>
        <apex:stylesheet value="{!URLFOR($Resource.EMSHtmlStyleNew, 'css/foundation.css')}"/>
        <apex:stylesheet value="{!URLFOR($Resource.EMSHtmlStyleNew, 'css/font-awesome.css')}"/>
        <apex:stylesheet value="{!URLFOR($Resource.EMSHtmlStyleNew, 'css/finalSteps.css')}"/>
        <apex:includeScript value="{!URLFOR($Resource.EMSHtmlStyleNew, 'js/jquery-1.9.1.js')}"/>
        <apex:includeScript value="{!URLFOR($Resource.EMSHtmlStyleNew, 'js/foundation.min.js')}"/>
        <apex:includeScript value="{!URLFOR($Resource.EMSHtmlStyleNew, 'js/jquery.blockUI.js')}"/>
        <script>
        var globalStaticResourcePath = '{!URLFOR($Resource.EMSHtmlStyleNew)}';
        $(document).ready(function(){
            $(".navBar div").click(function(){
                $(".active").removeClass("active");
                $(this).addClass("active");
            });
            $("#granted").click(function() {
                $("#grantedDiv").show();
                $("#pendingDiv").hide();
                $("#availableDiv").hide();
            });
            $("#pending").click(function() {
                $("#pendingDiv").show();
                $("#grantedDiv").hide();
                $("#availableDiv").hide();
            });
            $("#available").click(function() {
                $("#availableDiv").show();
                $("#pendingDiv").hide();
                $("#grantedDiv").hide();
            });
            $('.toggleSpan').click(function() {
                $(this).closest('.alignRight1').next().find('.detailsDiv').toggle();
            });
            $('.openAll').click(function() {
                $(document).find('.detailsDiv').show();
            });
            $('.closeAll').click(function() {
                $(document).find('.detailsDiv').hide();
            });
            $(document).on('click','#addAccount',function(){
                $(document).find('#accDetailes').hide();
                $(document).find('#addAccount').hide();
                $('#addAccountForm').prev().html('Add Account Details');
                $(document).find('#addAccountForm').show();
                $(document).find('.submitButtonLast').hide();
                $(document).find('#accNo').val('');
                $(document).find('#addres').val('');
                $(document).find('#busiNo').val('');
            });
            $(document).on('click','#cancelAccount',function(){
                $(document).find('#addAccountForm').hide();
                $(document).find('#addAccount').show();
                $(document).find('#accDetailes').show();
                $(document).find('.submitButtonLast').show();
                $('#addAccountForm').prev().html('Account Details');
            });
            // role info
            $('#helpInfo').click(function(){
                $('#helpinfodiv').foundation('reveal','open');
            });
            $('.close-reveal-modal').click(function(){
                $(this).parent().hide();
                $('.reveal-modal-bg').hide();
                $('#helpinfodiv').removeClass('open');
                $('#appinfodiv').removeClass('open');
                $('#appinfodiv').find('h1').remove();
                $('#appinfodiv').find('h3').remove();
                $('#appinfodiv').find('p').remove();
                $('#grantAccessDiv').removeClass('open');
                $('#grantAccessDiv').find('h4').remove();
                $('#grantAccessDiv').find('h6').remove();
                $('#grantAccessDiv').find('h5').remove();
                $('#grantAccessDiv').find('div').remove();
                $('#grantAccessDiv').find('p').remove();
                $('#grantAccessDiv').find('hr').remove();
                $('#grantAccessDiv a').not('.close-reveal-modal').remove();
            });
            $('.divClass .spanDiv span.contains').each(function() {
                if($(this).is(':contains("WinField")')) {
                    var c = globalStaticResourcePath+'/images/winfield-logo.jpg';
                    $(this).closest(".spanDiv").after('<div class="Clogo large-12 medium-12 small-12"><span><img src="'+c+'" /></span></div>'); 
                }
                if($(this).is(':contains("Purina")')) {
                    var c = globalStaticResourcePath+'/images/purina-logo.jpg';
                    $(this).closest(".spanDiv").after('<div class="Clogo large-12 medium-12 small-12"><span><img src="'+c+'" /></span></div>'); 
                }
                if($(this).is(':contains("Dairy")')) {
                    var c = globalStaticResourcePath+'/images/landOlakes-logo.jpg';
                    $(this).closest(".spanDiv").after('<div class="Clogo large-12 medium-12 small-12"><span><img src="'+c+'" /></span></div>'); 
                }
                if($(this).is(':contains("Corporate")')) {
                    var c = globalStaticResourcePath+'/images/landOlakesINC-logo.jpg';
                    $(this).closest(".spanDiv").after('<div class="Clogo large-12 medium-12 small-12"><span><img src="'+c+'" /></span></div>'); 
                }
                if($(this).is(':contains("FGI")')) {
                    var c = globalStaticResourcePath+'/images/Forage-Genetics-International-Logo.png';
                    $(this).closest(".spanDiv").after('<div class="Clogo large-12 medium-12 small-12"><span><img src="'+c+'" /></span></div>'); 
                }
                if($(this).is(':contains("Business Link Home Pages")')) {
                    var c = globalStaticResourcePath+'/images/allLogos.png';
                    $(this).closest(".spanDiv").after('<div class="large-12 medium-12 small-12"><span><img src="'+c+'" /></span></div>'); 
                }
                
                if($(this).is(':contains("Multiple Business Units")')) {
                    var c = globalStaticResourcePath+'/images/allLogos.png';
                    $(this).closest(".spanDiv").after('<div class="large-12 medium-12 small-12"><span><img src="'+c+'" /></span></div>'); 
                }
            });
        });
        function myfunction(id1,id2) {
            $('#appinfodiv').append('<h1>'+id1+'</h1>');
            $('#appinfodiv').append('<p>'+id2+'</p>');
            $('#appinfodiv').foundation('reveal','open');
        }
        function isChecked(e) {
            if($(".chkSelected:checked").length == 0){
                e.preventDefault();
                $('#appinfodiv').append('<h3 style="color: red;font-weight: bold;text-align: center;">Please select at least one application to Request Access.</h3>');
                $('#appinfodiv').foundation('reveal','open');
            }
        }
        function closeAndRefresh(){
            opener.location.reload(); // or opener.location.href = opener.location.href;
            window.close(); // or self.close();
        }
        </script>
        <style>
            .navBar a {color: #fff;text-decoration: none;padding: 3px 7px;border-radius: 5px;-webkit-border-radius: 5px;-moz-border-radius: 5px;}
            .navBar .classPad{padding: 3px 7px;cursor:pointer;}
            .navBar .classPad a{color:#263747;}
            .navBar .classPad:nth-child(1){border-top-left-radius: 5px;border-top-right-radius: 0px;border-bottom-right-radius: 0px;border-bottom-left-radius: 5px}
            .navBar .classPad:nth-child(3){border-top-left-radius: 0px;border-top-right-radius: 5px;border-bottom-right-radius: 5px;border-bottom-left-radius: 0px}
            .active {text-decoration: none;padding: 3px 7px;background-color: #263747;}
            .navBar .classPad.active a{color:#fff;}
            .divClass{background: #EFF1F2 none repeat scroll 0 0;display: block;padding: 4%;}
            .Clogo{background-color: #fff;height:85px;text-align:center;display:table;margin: 0 auto;}
            .Clogo span{vertical-align: middle;display: table-cell;}
            .Clogo img{width:8rem;}
            .padZero{font-size: 14px;}
            .titles{font-family:'Open Sans',Arial,sans-serif;font-size:17px;font-weight:bold;}
            .descirption{text-align: justify;}
            .contains{font-size: 17px;font-weight: bold;color: #585555;}
            .marBot{ clear: both;margin-bottom: 1%;}
            .toggleSpan{cursor:pointer;width: 50px;font-size: 20px;font-weight: bold;}
            .alignRight{ font-size: 13px;font-weight: bold;margin-top: 1%;text-align: right;}
            .closeAllPad{padding-bottom: 2%; padding-left: 3%;}
            .openAllPad{padding-bottom: 2%;padding-left: 3%;padding-right: 2%;}
            #accDetailes{height:150px;overflow-y:scroll;}
            .submitButtonLast{background: #DBE6EE none repeat scroll 0 0;margin-top: 1%;padding: 1%;text-align: center;}
            .rfLabel{margin-bottom:16px;}
        </style>
    </head>
    <header>
        <c:LogoHeaderBar headerName="Request Access"/>
        <div class="row">
            <div class="large-12 medium-12 small-12 columns right" style="padding: 2% 2% 0% 2%;">
                <div class="large-5 medium-5 small-12 columns">
                    <div>
                        <apex:outputText rendered="{!$User.Id != userDB.Id}">
                            Administrator: {!$User.LastName}, {!$User.FirstName}
                        </apex:outputText>
                    </div>
                    <div>
                        <span class="left heading" style="background: none;color: #000;font-weight: bold;font-size: 14px;">User: {!userDB.LastName}, {!userDB.FirstName}</span>
                    </div>
                </div>
                <div class="large-7 medium-7 small-12 columns">
                    <apex:outputText rendered="{!$User.Id == userDB.Id}">
                        <span style="float: right;">
                            <table style="background: #dbe6ee none repeat scroll 0 0;border: medium none;">
                                <tr>
                                    <td class="profileIcon" style="padding-right: 25px;"></td>
                                    <td><a href="/ems/profile">My Profile</a></td>
                                    <td><span>|</span></td>
                                    <td class="helpCircle" style="padding-right: 25px;"></td>
                                    <td><a href="#" id="helpInfo">Help</a></td>
                                    <apex:outputText rendered="{!$Profile.Name == 'EMS Delegated Admin'}">
                                        <td><span>|</span></td>
                                        <td><a href="/ems/EMSDelegatedAdminPage" target="_blank">Delegated Admin</a></td>
                                    </apex:outputText>
                                </tr>
                            </table>
                        </span>
                    </apex:outputText>
                </div>
            </div>
        </div>
    </header>
    <section>       
        <c:PageMessages />
        <apex:form >
            <div class="row">
                <apex:repeat value="{!APWrapper}" var="pApp2">
                    <div class="large-12 medium-12 small-12 columns text-center" style="background: #EFF1F2 none repeat scroll 0 0;padding: 2%;">
                        <div class="navBar clearfix" style="border: 1px solid;border-radius: 5px;margin: 0 auto;width: 50%;">
                            <div id="granted" class="large-4 medium-4 small-12 columns classPad active" style="border-right: 1px solid;">
                                <a>Granted&nbsp;({!pApp2.grantedSize})</a>
                            </div>
                            <div class="large-4 medium-4 small-12 columns classPad" style="border-right: 1px solid;">
                                <a id="pending">Pending&nbsp;({!pApp2.pendingSize})</a>
                            </div>
                            <div id="available" class="large-4 medium-4 small-12 columns classPad">
                                <a>Available&nbsp;({!pApp2.availableSize})</a>
                            </div>
                        </div>
                        <div style="margin-top: 4%;">
                            <hr />
                        </div>
                    </div>
                    <div style="display:{!if(pApp2.grantedSize > 0,"block","none")};">
                        <div class="large-12 medium-12 small-12 divClass" id="grantedDiv">
                            <div class="alignRight">
                                <a href="#" class="openAll openAllPad">Open All</a>
                                <a href="#" class="closeAll closeAllPad">Close All</a>
                            </div>
                            <apex:repeat value="{!pApp2.grantedMap}" var="child">
                                <div class="alignRight1">
                                    <span class="toggleSpan">+</span>
                                </div>
                                <div class="large-12 medium-12 small-12 clearfix">
                                    <div class="headTitle">
                                        <div class="large-12 medium-12 small-12">
                                            <div class="large-12 medium-12 small-12 text-center marBot">
                                                <div class="spanDiv large-12 medium-12 small-12"><span class="contains">{!child}
                                                    <apex:variable value="{!pApp2.grantedMap[child]}"  var="grantedMap" />
                                                    <apex:outputText value="({!grantedMap.size})"/></span></div>
                                            </div>
                                        </div>                                     
                                    </div>                                
                                    <div class="detailsDiv clearfix">
                                        <div class="large-12 medium-12 small-12 clearfix titles marBot">
                                            <div class="large-3 medium-3 small-12 columns">Application</div>
                                            <div class="large-6 medium-6 small-12 columns">Short Description</div>
                                            <div class="large-1 medium-1 small-12 columns">Info</div>
                                            <div class="large-2 medium-2 small-12 columns">Status</div>
                                        </div>
                                        <apex:repeat value="{!pApp2.grantedMap[child]}" var="gchild">
                                            <div class="large-12 medium-12 small-12 clearfix marBot padZero">
                                                <div class="large-3 medium-3 small-12 columns">{!gchild.Name}</div>
                                                <div class="large-6 medium-6 small-12 columns descirption">{!gchild.Short_description__c}</div>
                                                <div class="large-1 medium-1 small-12 columns">
                                                    <label class="eye" style="height: 32px;cursor:pointer !important;" onclick='myfunction("{!gchild.Name}","{!gchild.Description__c}");' />
                                                </div>
                                                <div class="large-2 medium-2 small-12 columns" style="color:green;">Granted</div>
                                            </div>
                                        </apex:repeat>
                                    </div>
                                </div>
                                <hr />
                            </apex:repeat>
                        </div>
                    </div>
                    <div class="large-12 medium-12 small-12 divClass" id="pendingDiv" style="display:none;">
                        <div class="alignRight">
                            <a href="#" class="openAll openAllPad">Open All</a>
                            <a href="#" class="closeAll closeAllPad">Close All</a>
                        </div>
                        <apex:repeat value="{!pApp2.pendingAppMap}" var="child">
                            <div class="alignRight1">
                                <span class="toggleSpan">+</span>
                            </div>
                            <div class="large-12 medium-12 small-12 clearfix">
                                <div class="headTitle">
                                    <div class="large-12 medium-12 small-12">
                                        <div class="large-12 medium-12 small-12 text-center marBot">
                                            <div class="spanDiv large-12 medium-12 small-12"><span class="contains">{!child}
                                                <apex:variable value="{!pApp2.pendingAppMap[child]}"  var="pendingAppMap" />
                                                <apex:outputText value="({!pendingAppMap.size})"/></span></div>
                                        </div>
                                    </div>                                     
                                </div>                                
                                <div class="detailsDiv clearfix">
                                    <div class="large-12 medium-12 small-12 clearfix titles marBot">
                                        <div class="large-3 medium-3 small-12 columns">Application</div>
                                        <div class="large-6 medium-6 small-12 columns">Short Description</div>
                                        <div class="large-1 medium-1 small-12 columns">Info</div>
                                        <div class="large-2 medium-2 small-12 columns">Status</div>
                                    </div>
                                    <apex:repeat value="{!pApp2.pendingAppMap[child]}" var="gchild">
                                        <div class="large-12 medium-12 small-12 clearfix marBot padZero">
                                            <div class="large-3 medium-3 small-12 columns">{!gchild.Name}</div>
                                            <div class="large-6 medium-6 small-12 columns descirption">{!gchild.Short_description__c}</div>
                                            <div class="large-1 medium-1 small-12 columns">
                                                <label class="eye" style="height: 32px;cursor:pointer !important;" onclick='myfunction("{!gchild.Name}","{!gchild.Description__c}");' />
                                            </div>
                                            <div class="large-2 medium-2 small-12 columns" style="color:green;">Pending</div>
                                        </div>
                                    </apex:repeat>
                                </div>
                            </div>
                            <hr />
                        </apex:repeat>
                    </div>
                    <div style="display:{!if(pApp2.availableSize > 0,"block","none")};">
                        <div class="large-12 medium-12 small-12 divClass" id="availableDiv" style="display:none;">
                            <!-- div class="large-12 medium-12 small-12 columns text-center">                    
<apex:commandButton styleClass="submitButton" style="padding:0;" onclick="isChecked(event)" action="{!requestAccess}" value="REQUEST ACCESS" id="requestButton1"/>
</div -->
                            <div class="alignRight">
                                <a href="#" class="openAll openAllPad">Open All</a>
                                <a href="#" class="closeAll closeAllPad">Close All</a>
                            </div>
                            <apex:repeat value="{!pApp2.avalAppMap}" var="child">
                                <div class="alignRight1">
                                    <span class="toggleSpan">+</span>
                                </div>
                                <div class="large-12 medium-12 small-12 clearfix">
                                    <div class="headTitle">
                                        <div class="large-12 medium-12 small-12">
                                            <div class="large-12 medium-12 small-12 text-center marBot">
                                                <div class="spanDiv large-12 medium-12 small-12"><span class="contains">{!child}
                                                    <apex:variable value="{!pApp2.avalAppMap[child]}"  var="avalAppMap" />
                                                    <apex:outputText value="({!avalAppMap.size})"/></span></div>
                                            </div>
                                        </div>                                     
                                    </div>                                
                                    <div class="detailsDiv clearfix">
                                        <div class="large-12 medium-12 small-12 clearfix titles marBot">
                                            <div class="large-4 medium-2 small-12 columns">Application</div>
                                            <div class="large-5 medium-4 small-12 columns">Short Description</div>
                                            <div class="large-2 medium-2 small-12 columns">Info</div>
                                            <!--div class="large-3 medium-3 small-12 columns">Comments</div -->
                                            <div class="large-1 medium-1 small-12 columns">Select</div>
                                        </div>
                                        <apex:repeat value="{!pApp2.avalAppMap[child]}" var="gchild">
                                            <div class="large-12 medium-12 small-12 clearfix marBot padZero">
                                                <div class="large-4 medium-2 small-12 columns">{!gchild.AppName}</div>
                                                <div class="large-5 medium-4 small-12 columns descirption">{!gchild.AppShortDescription}</div>
                                                <div class="large-2 medium-2 small-12 columns"><label class="eye" style="height: 32px;cursor:pointer !important;" onclick='myfunction("{!gchild.AppName}","{!gchild.AppDescription}");' /></div>
                                                <!-- div class="large-3 medium-3 small-12 columns"><apex:inputText id="reason" value="{!gchild.reason}" /></div -->
                                                <div class="large-1 medium-1 small-12 columns">
                                                    <a onclick='grantAccess("{!gchild.AppName}","{!gchild.AppId}","{!gchild.AppDescription}","{!gchild.FineGrainInstructions}","{!gchild.FGMaxEnts}","{!gchild.FGmgmt}")'>REQUEST</a>
                                                </div>
                                            </div>
                                        </apex:repeat>
                                    </div>
                                </div>
                                <hr />
                            </apex:repeat>
                            <!-- div class="large-12 medium-12 small-12 columns text-center">                    
<apex:commandButton styleClass="submitButton" style="padding:0;" onclick="isChecked(event)" action="{!requestAccess}" value="REQUEST ACCESS" id="requestButton"/>
</div -->
                        </div>
                    </div>
                </apex:repeat>
            </div>
        </apex:form>
    </section>
    <footer>
        <c:LogoFooterBar />
    </footer>
    <style>
        .divModal{background: #eee none repeat scroll 0 0;border-radius:5px;padding: 3%;}
        .divModalWhite{background: #fff none repeat scroll 0 0;border-radius:5px;padding: 3%;}
    </style>
    <div id="helpinfodiv" class="reveal-modal divModal" style="font-size: 15px;">
        <h6><b>Overview</b></h6>
        <p style="font-size: 15px;">In this page you will be shown applications to which you have access to (under Granted tab), applications which you can request access for (Available tab) and status of your application request under (Pending tab). Pending tab will be made available by middle of 2016.   
            <br/>In this page for ease of readability/finding applications have been grouped under the respective Land O Lakes Business Units. There are four Business Units of Land O Lakes â€“ Corporate, Diary, Purina and WinField. 
        </p>
        <h6><b>How to navigate the page:</b></h6>
        <p style="font-size: 15px;">On clicking "My access" link on top right hand side corner of the page in â€œYour Profileâ€� page you will be taken to "My Request" page.
            <br/>By default in â€œRequest Accessâ€� page you will be taken to â€œGrantedâ€� page, showing application/s to which you have access to.
            <br/>In this page for ease of readability/ locating applications have been grouped under the respective Land O Lakes Business Units. There are four Business Units of Land O Lakes â€“ Corporate, Diary, Purina and WinField.
            <br/>You can toggle between Granted, Available and Pending (shortly coming). Tab which is open will be highlighted in dark blue.</p>
        <li>Available â€“ This will list application/s which you could request access to. Please discuss with your Manager or your Land O Lakes Business Unit sales contact for guidance on which application/s you must request access for.</li>
        <li>Pending â€“ This will list application/s that you have requested access to and is under review for approval by Land O Lakes Business Unit/s.</li>
        <br/><p>Situations when an application belongs to multiple LOL Business Units you will find it under special group of all Business Units.</p>
        <h6><b>Granted</b></h6>
        <ol style="font-size: 15px;">
            <li>Always first confirm what application/s you have access granted.</li>
            <li>If you do not see the application listed here, click on Pending tab. This will show you the application that you had requested access for and its status.</li>
        </ol>
        <h6><b>Pending</b></h6>
        <ol style="font-size: 15px;">
            <li>Pending â€“ This will list application/s that you have requested access to and in the process of review for approval by Land O Lakes Business Unit/s.</li>
            <li>If you do not see here also the application, navigate to Available tab to request application access to submit request for application access, click on â€œAvailableâ€� tab.</li>
        </ol>
        <h6><b>Available</b></h6>
        <ol style="font-size: 15px;">
            <li>Navigate to the LOL Business Unit/s with which you are doing business with.</li>
            <li>Select the application you need access by selecting the check box on the extreme right hand side of the application</li>
            <li>Enter details in comment field which will help in granting access to the application Work with your Manager or LOL Business Unit sales person for guidance.</li>
            <li>In one request submission you can request access to more than one application.</li>
            <li>Click on â€œRequest accessâ€� button to submit once you have selected your list of application/s.</li>
            <li>You will get confirmation message on successful submission on the top of the page.</li>
        </ol>
        <a class="close-reveal-modal">&#215;</a>
    </div>
    <div id="appinfodiv" class="large-12 medium-12 small-12 reveal-modal divModal">
        <a class="close-reveal-modal">&#215;</a>
    </div>
    <script>
    function grantAccess(a,b,c,d,e,f) {
        $('#grantAccessDiv').append('<h4>'+a+'</h4>');
        $('#grantAccessDiv').append('<h6>'+c+'</h6><hr>');
        //$('#grantAccessDiv').append('<h3>'+b+'</h3>');
        $('#grantAccessDiv').append('<h6>Entry Instructions</h6><p>'+d+'</p>');
        if(f == 'true') {
            var globalhtml = '<div id="managerDiv" class="row large-12 medium-12 small-12 columns" style="padding: 0px;">'+
                '<div><div class="rfLabel large-4 medium-6 small-12 columns" style="padding: 0px;"><span class="prefix"><strong>Comments</strong></span></div>'
            + '<div class="rfValue large-8 medium-6 small-12 columns" style="padding: 0px;"><input rfID="Comments" type="text" /></div></div>';
            Visualforce.remoting.Manager.invokeAction('{!$RemoteAction.ExternalRequestCntrl.prepopRequestFields}',b,'{!$CurrentPage.parameters.userId}', function(result, event){
                if (event.status && event.result) { 
                    for(var i = 0; i < result.length; i++){ 
                        globalhtml = globalhtml + '<div><div class="rfLabel large-4 medium-6 small-12 columns" style="padding: 0px;">' 
                        + '<span class="prefix"><strong>'+result[i].Id+'</strong></span></div>'
                        + '<div class="rfValue large-8 medium-6 small-12 columns" style="padding: 0px;"><input placeholder="Please enter a value" value="'+result[i].value+'" reqattr='+result[i].required+' rfID='+result[i].rfId+' ftype='+result[i].fieldType+' type="text" /></div></div>';
                    }
                    globalhtml = globalhtml + '</div><h6>Account Details</h6><div id="addAccountForm" class="clearfix" style="display:none;">'+
                        '<div class="large-6 medium-6 small-12 columns" style="padding: 0px;"><label>Business Name</label>'+
                        '<input type="text" id="accNo"/> <label>Account No.</label><input type="text" id="busiNo"/></div>'+
                        '<div class="large-6 medium-6 small-12 columns" style="padding: 0px;"><label>Street, City, State PostalCode, Country</label>'+
                        '<textarea rows="4" cols="50" id="addres"/></div>' +
                        '<div class="large-12 medium-12 small-12 columns" style="text-align:right;font-size: 17px;">'+
                        '<a style="margin-right: 4%;" id="cancelAccount">Cancel</a><a onclick="addContact('+"'"+b+"'"+');" id="saveAccount">Save</a>'+
                        '</div>';
                    $('#grantAccessDiv').append(globalhtml);
                } else {
                    alert(event.message);
                }
            }, {escape:true});
            fetchContacts(b);
            $('#grantAccessDiv').foundation('reveal','open');
        } else {
            var globalhtml = '<div id="managerDiv" class="row large-12 medium-12 small-12 columns" style="padding: 0px;">'+
                '<div><div class="rfLabel large-4 medium-6 small-12 columns" style="padding: 0px;"><span class="prefix"><strong>Comments</strong></span></div>'
            + '<div class="rfValue large-8 medium-6 small-12 columns" style="padding: 0px;"><input rfID="Comments" type="text" /></div></div>';
            globalhtml = globalhtml + '<div style="margin-top: 1%;" class="submitButtonLast large-12 medium-12 small-12 columns"><a onclick ="submitRequest('+"'"+b+"'"+');" id="submitButton">Submit</a></div>';
            $('#grantAccessDiv').append(globalhtml);
            $('#grantAccessDiv').foundation('reveal','open');
        }
    }
    var accounts = new Array();
    function Account(Name,Address,AcctNo){
        this.Name = Name;
        this.Address = Address;
        this.AcctNo = AcctNo;
    }
    var fetchContacts = function(b) {
        accounts = [];
        Visualforce.remoting.Manager.invokeAction('{!$RemoteAction.ExternalRequestCntrl.fetchAccountsForRequest}',b,'{!$CurrentPage.parameters.userId}', function(result, event){
            if (event.status && event.result) { 
                console.log(event.result);
                for(var i = 0; i < result.length; i++){
                    var accIt  = new Account(result[i].Name,result[i].Address,result[i].AcctNo);
                    accounts.push(accIt);
                }
                populateAccDetails(b, accounts);
            }else {
                alert(event.message);
            }
        }, {escape:true});
    };
    var populateAccDetails = function(applId, mergedArray) {
        var html = '<div id="accDetailes" class="row large-12 medium-12 small-12 columns" style="padding: 0px;margin-bottom: 2%;">'+
            '<div style="font-size: 14px;font-weight: bold;margin-bottom: 1%;" class="clearfix"><div class="large-3 medium-3 small-2 columns">Business Name</div>'+
            '<div class="large-5 medium-5 small-6 columns">Address</div>'+
            '<div class="large-2 medium-2 small-2 columns">Account No.</div>'+
            '<div class="large-2 medium-2 small-2 columns">Actions</div></div>';
        for(var i = 0; i < mergedArray.length; i++) {
            if(i%2 == 0){
                html = html + '<div style="font-size: 14px;background:#eee;padding:5px 0;" class="divId clearfix"><div class="large-3 medium-3 small-3 columns">';
            } else {
                html = html + '<div style="font-size: 14px;padding:5px 0;" class="divId clearfix"><div class="large-3 medium-3 small-2 columns">';
            }
            html = html + mergedArray[i].Name+'</div><div class="large-5 medium-5 small-6 columns">'
            +mergedArray[i].Address+'</div><div class="large-2 medium-2 small-2 columns">'
            +mergedArray[i].AcctNo+'</div><div class="large-2 medium-2 small-2 columns">'
            +'<a onclick="editContact(event);">Edit</a>'
            +'<a style="margin-left: 4%;" onclick="deleteContact('+"'"+applId+"'"+',event);">Delete</a></div></div>';
        }
        html = html + '</div><a id="addAccount">+ Add Account</a></div>';
        html = html + '<div style="margin-top: 1%;"><a onclick ="submitRequest('+"'"+applId+"'"+');" class="submitButtonLast large-12 medium-12 small-12 columns" id="submitButton">Submit</a></div>';
        $('#grantAccessDiv').append(html);
    };
    var indexEdit=-1;
    var addContact = function(aId) {
        if(indexEdit<0){
            accounts.unshift(new Account($('#accNo').val(),$('#addres').val(),$('#busiNo').val()));
        }else{            
            accounts[indexEdit].Name=$('#accNo').val();
            accounts[indexEdit].Address=$('#addres').val();
            accounts[indexEdit].AcctNo=$('#busiNo').val();
        }
        $('#addAccountForm').prev().html('Account Details');
        $(document).find('#addAccountForm').hide();
        $(document).find('#accDetailes').remove();
        $(document).find('#addAccount').remove();
        $(document).find('.submitButtonLast').remove();
        populateAccDetails(aId, accounts);
        indexEdit=-1;
    };
    var deleteContact = function(applId,thisVar) {
        accounts.splice($(thisVar.target).closest('.divId').index()-1,1);
        $(thisVar.target).closest('.divId').remove();
        $(document).find('#accDetailes').remove();
        $(document).find('#addAccount').remove();
        $(document).find('.submitButtonLast').remove();
        populateAccDetails(applId, accounts);
    };
    var editContact = function(thisVar) {
        indexEdit = $(thisVar.target).closest('.divId').index()-1;    
        $(document).find('#accDetailes').hide();
        $(document).find('#addAccount').hide();
        $('#addAccountForm').prev().html('Edit Account Details');
        $(document).find('#addAccountForm').show();
        $(document).find('.submitButtonLast').hide();
        $('#accNo').val($(thisVar.target).closest('.divId').find('.columns').eq(0).text());
        $('#addres').val($(thisVar.target).closest('.divId').find('.columns').eq(1).text());
        $('#busiNo').val($(thisVar.target).closest('.divId').find('.columns').eq(2).text());
    };
    var rfs = new Array();
    function RequestField(value,rfId,Id,fieldType,required){
        this.value = value;
        this.rfId = rfId;
        this.Id = Id;
        this.fieldType = fieldType;
        this.required = required;
    }
    var submitRequest = function(appId) {
        rfs = [];
        var flag = false;
        var inputComments;
        $('#managerDiv').children().each(function (index, value) {
            var rfidd =  $(this).find('.rfValue input').attr('rfID');
            if(rfidd != null) {
                if(rfidd == 'Comments') {
                    inputComments = $(this).find('.rfValue input').val();
                } else {
                    var inputValue = $(this).find('.rfValue input').val();
                    var attrReq =  $(this).find('.rfValue input').attr('reqattr');
                    var ftype =  $(this).find('.rfValue input').attr('ftype');
                    var fieldLabel = $(this).find('.rfLabel strong').text();
                    if(attrReq == 'true' && inputValue.length == 0 && ftype != 'Phone' && ftype != 'Email') {
                        $(this).find('input').attr('style', "border-color: #FF0000;");
                        $(this).find('input').val('');
                        $(this).find('input').attr("placeholder","This field can not be blank");
                        flag = true;
                    } else {
                        $(this).find('input').attr('style', "border-color: #cccccc;");
                    } 
                    if (ftype == 'Phone') {
                        if(!validatePhone(inputValue)) {
                            $(this).find('input').attr('style', "border-color: #FF0000;");
                            $(this).find('input').val('');
                            $(this).find('input').attr("placeholder","Please enter a valid phone number");
                            flag = true;
                        } else {
                            $(this).find('input').attr('style', "border-color: #cccccc;");
                        }
                    } if (ftype == 'Email') {
                        if(!isValidEmailAddress(inputValue)) {
                            $(this).find('input').attr('style', "border-color: #FF0000;");
                            $(this).find('input').val('');
                            $(this).find('input').attr("placeholder",'Please enter a valid email address');
                            flag = true;
                        } else {
                            $(this).find('input').attr('style', "border-color: #cccccc;");
                        }
                    }
                    rfs.push(new RequestField(inputValue,rfidd,fieldLabel,ftype,attrReq));
                }
            }
        });
        console.log(appId);console.log(accounts);console.log(rfs);console.log(inputComments);
        if(!flag) {
            $('.submitButtonLast').hide();
            $.blockUI({ css: { 
                border: 'none', 
                padding: '15px', 
                backgroundColor: '#000', 
                '-webkit-border-radius': '10px', 
                '-moz-border-radius': '10px', 
                opacity: .5, 
                color: '#fff' 
            } });
            Visualforce.remoting.Manager.invokeAction('{!$RemoteAction.ExternalRequestCntrl.submitRequest}',appId,accounts,rfs,inputComments,'{!$CurrentPage.parameters.userId}', function(result, event){
                if (event.status && event.result) {
                    window.location.reload();
                    $.unblockUI();
                } else {
                    window.location.reload();
                    $.unblockUI();
                }
            }, {escape:true});
        }
    };
    function validatePhone(txtPhone) {
        var pattern = new RegExp(/^[(]{0,1}[0-9]{3}[)]{0,1}[-\s\.]{0,1}[0-9]{3}[-\s\.]{0,1}[0-9]{4}$/);
        return pattern.test(txtPhone);
    }
    function isValidEmailAddress(emailAddress) {
        var pattern = /^([a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+(\.[a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)*|"((([ \t]*\r\n)?[ \t]+)?([\x01-\x08\x0b\x0c\x0e-\x1f\x7f\x21\x23-\x5b\x5d-\x7e\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|\\[\x01-\x09\x0b\x0c\x0d-\x7f\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))*(([ \t]*\r\n)?[ \t]+)?")@(([a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.)+([a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.?$/i;
        return pattern.test(emailAddress);
    }
    </script>
    <div id="grantAccessDiv" class="large-12 medium-12 small-12 reveal-modal divModalWhite">
        <a class="close-reveal-modal">&#215;</a>
    </div>
</apex:page>