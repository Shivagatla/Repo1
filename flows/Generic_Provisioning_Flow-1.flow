<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <actionCalls>
        <name>Send_email_to_user</name>
        <label>Send email to user</label>
        <locationX>466</locationX>
        <locationY>550</locationY>
        <actionName>UserProvisioningRequest.New_Provisioned_Access</actionName>
        <actionType>emailAlert</actionType>
        <connector>
            <targetReference>Lookup_URP_Owner</targetReference>
        </connector>
        <inputParameters>
            <name>SObjectRowId</name>
            <value>
                <elementReference>UserProvisioningRequest.Id</elementReference>
            </value>
        </inputParameters>
    </actionCalls>
    <apexPluginCalls>
        <name>Create_User_Manually</name>
        <label>Provision User</label>
        <locationX>488</locationX>
        <locationY>147</locationY>
        <apexClass>GenericProvCreatePlugin</apexClass>
        <connector>
            <targetReference>Is_Manual_Provisioning_Needed</targetReference>
        </connector>
        <inputParameters>
            <name>ConnectedAppId</name>
            <value>
                <elementReference>UserProvisioningRequest.ConnectedAppId</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>email</name>
            <value>
                <elementReference>User.Email</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>familyName</name>
            <value>
                <elementReference>User.LastName</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>profileId</name>
            <value>
                <stringValue>00e63000000DdwR</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>username</name>
            <value>
                <elementReference>User.Username</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>debugLogging</name>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>givenName</name>
            <value>
                <elementReference>UserNameFormula</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>userProvisioningRequestId</name>
            <value>
                <elementReference>UserProvisioningRequest.Id</elementReference>
            </value>
        </inputParameters>
        <outputParameters>
            <assignToReference>Details</assignToReference>
            <name>Details</name>
        </outputParameters>
        <outputParameters>
            <assignToReference>ExternalEmail</assignToReference>
            <name>ExternalEmail</name>
        </outputParameters>
        <outputParameters>
            <assignToReference>ExternalFirstName</assignToReference>
            <name>ExternalFirstName</name>
        </outputParameters>
        <outputParameters>
            <assignToReference>ExternalLastName</assignToReference>
            <name>ExternalLastName</name>
        </outputParameters>
        <outputParameters>
            <assignToReference>ExternalUserId</assignToReference>
            <name>ExternalUserId</name>
        </outputParameters>
        <outputParameters>
            <assignToReference>ExternalUsername</assignToReference>
            <name>ExternalUsername</name>
        </outputParameters>
        <outputParameters>
            <assignToReference>Status</assignToReference>
            <name>Status</name>
        </outputParameters>
        <outputParameters>
            <assignToReference>UserID</assignToReference>
            <name>User ID</name>
        </outputParameters>
        <outputParameters>
            <assignToReference>NeedsManualProvisioning</assignToReference>
            <name>NeedManual</name>
        </outputParameters>
    </apexPluginCalls>
    <constants>
        <name>CaseRT</name>
        <dataType>String</dataType>
        <value>
            <stringValue>EMS Provisioning</stringValue>
        </value>
    </constants>
    <constants>
        <name>CustomerSupportQueueName</name>
        <dataType>String</dataType>
        <value>
            <stringValue>EMSCustomer_Support</stringValue>
        </value>
    </constants>
    <constants>
        <name>ManualProvCaseSubject</name>
        <dataType>String</dataType>
        <value>
            <stringValue>Manual Provisioning is Needed for a user</stringValue>
        </value>
    </constants>
    <constants>
        <name>NewCaseStatus</name>
        <dataType>String</dataType>
        <value>
            <stringValue>New</stringValue>
        </value>
    </constants>
    <constants>
        <name>QueueType</name>
        <dataType>String</dataType>
        <value>
            <stringValue>Queue</stringValue>
        </value>
    </constants>
    <constants>
        <name>SobjectRTType</name>
        <dataType>String</dataType>
        <value>
            <stringValue>Case</stringValue>
        </value>
    </constants>
    <decisions>
        <name>Is_Manual_Provisioning_Needed</name>
        <label>Is Manual Provisioning Needed</label>
        <locationX>659</locationX>
        <locationY>145</locationY>
        <defaultConnector>
            <targetReference>Lookup_Target_App</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>[Default Outcome]</defaultConnectorLabel>
        <rules>
            <name>true</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>NeedsManualProvisioning</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Cart_Details_for_Provisioning</targetReference>
            </connector>
            <label>true</label>
        </rules>
    </decisions>
    <decisions>
        <name>Only_Send_email_for_non_system_apps</name>
        <label>Only Send email for non-system apps</label>
        <locationX>655</locationX>
        <locationY>387</locationY>
        <defaultConnectorLabel>[Default Outcome]</defaultConnectorLabel>
        <rules>
            <name>sendemail</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>needToSendEmail</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_UPR_Owner_to_UPR_Target</targetReference>
            </connector>
            <label>Send Email</label>
        </rules>
    </decisions>
    <decisions>
        <name>Operation</name>
        <label>Operation</label>
        <locationX>71</locationX>
        <locationY>139</locationY>
        <defaultConnectorLabel>[Default Outcome]</defaultConnectorLabel>
        <rules>
            <name>Create</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>UserProvisioningRequest.Operation</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Create</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Lookup_User</targetReference>
            </connector>
            <label>Create</label>
        </rules>
        <rules>
            <name>Update</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>UserProvisioningRequest.Operation</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Update</stringValue>
                </rightValue>
            </conditions>
            <label>Update</label>
        </rules>
        <rules>
            <name>Collect</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>UserProvisioningRequest.Operation</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Reconcile</stringValue>
                </rightValue>
            </conditions>
            <label>Collect</label>
        </rules>
        <rules>
            <name>Delete</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>UserProvisioningRequest.Operation</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Deactivate</stringValue>
                </rightValue>
            </conditions>
            <label>Delete</label>
        </rules>
    </decisions>
    <formulas>
        <name>fullName</name>
        <dataType>String</dataType>
        <expression>{!User.FirstName} + &apos; &apos; + {!User.LastName}</expression>
    </formulas>
    <formulas>
        <name>UserNameFormula</name>
        <dataType>String</dataType>
        <expression>{!User.FirstName} + {!User.LastName} + &apos;@testuserprov.org&apos;</expression>
    </formulas>
    <interviewLabel>Generic Provisioning Flow final 1.0 {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Generic Provisioning Flow final 1.1</label>
    <processType>UserProvisioningFlow</processType>
    <recordCreates>
        <name>CreateProvisioningCase</name>
        <label>CreateProvisioningCase</label>
        <locationX>1029</locationX>
        <locationY>454</locationY>
        <connector>
            <targetReference>Lookup_Target_App</targetReference>
        </connector>
        <inputAssignments>
            <field>ContactId</field>
            <value>
                <elementReference>User.ContactId</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Description</field>
            <value>
                <elementReference>Details</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>OwnerId</field>
            <value>
                <elementReference>queueId</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>RecordTypeId</field>
            <value>
                <elementReference>ProvisioningRTType</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Related_Cart__c</field>
            <value>
                <elementReference>CartApp.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Related_External_User__c</field>
            <value>
                <elementReference>User.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Subject</field>
            <value>
                <elementReference>ManualProvCaseSubject</elementReference>
            </value>
        </inputAssignments>
        <object>Case</object>
    </recordCreates>
    <recordLookups>
        <name>Get_Cart_Details_for_Provisioning</name>
        <label>Get Cart Details for Provisioning</label>
        <locationX>845</locationX>
        <locationY>141</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Lookup_Record_Type_for_case</targetReference>
        </connector>
        <filters>
            <field>UPR_Number__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>UserProvisioningRequest.Id</elementReference>
            </value>
        </filters>
        <object>Cart_Application__c</object>
        <outputAssignments>
            <assignToReference>CartApp.Id</assignToReference>
            <field>Id</field>
        </outputAssignments>
    </recordLookups>
    <recordLookups>
        <description>This step finds out the provisioning queue of the dis-connected (ie manually provisioned) application</description>
        <name>Get_Provisoining_Queue</name>
        <label>Get Provisoining Queue</label>
        <locationX>1008</locationX>
        <locationY>250</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>GetCustomerSupportQueue</targetReference>
        </connector>
        <filters>
            <field>Connected_App_ID__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>UserProvisioningRequest.ConnectedAppId</elementReference>
            </value>
        </filters>
        <object>Application__c</object>
        <outputAssignments>
            <assignToReference>CustomerSupportQueue</assignToReference>
            <field>Provisioning_Queue__c</field>
        </outputAssignments>
    </recordLookups>
    <recordLookups>
        <name>GetCustomerSupportQueue</name>
        <label>GetCustomerSupportQueue</label>
        <locationX>1019</locationX>
        <locationY>352</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>CreateProvisioningCase</targetReference>
        </connector>
        <filters>
            <field>DeveloperName</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>CustomerSupportQueueName</elementReference>
            </value>
        </filters>
        <filters>
            <field>Type</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>QueueType</elementReference>
            </value>
        </filters>
        <object>Group</object>
        <outputAssignments>
            <assignToReference>queueId</assignToReference>
            <field>Id</field>
        </outputAssignments>
    </recordLookups>
    <recordLookups>
        <name>Lookup_Record_Type_for_case</name>
        <label>Lookup Record Type for case</label>
        <locationX>1014</locationX>
        <locationY>137</locationY>
        <assignNullValuesIfNoRecordsFound>true</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_Provisoining_Queue</targetReference>
        </connector>
        <filters>
            <field>Name</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>CaseRT</elementReference>
            </value>
        </filters>
        <filters>
            <field>SobjectType</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>SobjectRTType</elementReference>
            </value>
        </filters>
        <object>RecordType</object>
        <outputAssignments>
            <assignToReference>ProvisioningRTType</assignToReference>
            <field>Id</field>
        </outputAssignments>
    </recordLookups>
    <recordLookups>
        <name>Lookup_Target_App</name>
        <label>Lookup Target App</label>
        <locationX>658</locationX>
        <locationY>295</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Only_Send_email_for_non_system_apps</targetReference>
        </connector>
        <filters>
            <field>Connected_App_ID__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>UserProvisioningRequest.ConnectedAppId</elementReference>
            </value>
        </filters>
        <object>Application__c</object>
        <outputAssignments>
            <assignToReference>needToSendEmail</assignToReference>
            <field>Send_Email__c</field>
        </outputAssignments>
    </recordLookups>
    <recordLookups>
        <name>Lookup_URP_Owner</name>
        <label>Lookup URP Owner</label>
        <locationX>665</locationX>
        <locationY>577</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Update_URP_Owner_again</targetReference>
        </connector>
        <filters>
            <field>Username</field>
            <operator>StartsWith</operator>
            <value>
                <stringValue>uprowner@landolakes.com.ems</stringValue>
            </value>
        </filters>
        <object>User</object>
        <outputAssignments>
            <assignToReference>UPROwnerID</assignToReference>
            <field>Id</field>
        </outputAssignments>
    </recordLookups>
    <recordLookups>
        <name>Lookup_User</name>
        <label>Lookup User</label>
        <locationX>304</locationX>
        <locationY>143</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Create_User_Manually</targetReference>
        </connector>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>UserProvisioningRequest.SalesforceUserId</elementReference>
            </value>
        </filters>
        <object>User</object>
        <outputReference>User</outputReference>
        <queriedFields>AccountId</queriedFields>
        <queriedFields>Alias</queriedFields>
        <queriedFields>CommunityNickname</queriedFields>
        <queriedFields>Email</queriedFields>
        <queriedFields>FirstName</queriedFields>
        <queriedFields>LastName</queriedFields>
        <queriedFields>Username</queriedFields>
        <queriedFields>External_Fed_Id__c</queriedFields>
        <queriedFields>ContactId</queriedFields>
    </recordLookups>
    <recordUpdates>
        <name>Update_UPR_Owner_to_UPR_Target</name>
        <label>Update UPR Owner to UPR Target</label>
        <locationX>650</locationX>
        <locationY>482</locationY>
        <connector>
            <targetReference>Send_email_to_user</targetReference>
        </connector>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>UserProvisioningRequest.Id</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>OwnerId</field>
            <value>
                <elementReference>UserProvisioningRequest.SalesforceUserId</elementReference>
            </value>
        </inputAssignments>
        <object>UserProvisioningRequest</object>
    </recordUpdates>
    <recordUpdates>
        <name>Update_URP_Owner_again</name>
        <label>Update URP Owner again</label>
        <locationX>811</locationX>
        <locationY>570</locationY>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>UserProvisioningRequest.Id</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>OwnerId</field>
            <value>
                <elementReference>UPROwnerID</elementReference>
            </value>
        </inputAssignments>
        <object>UserProvisioningRequest</object>
    </recordUpdates>
    <startElementReference>Operation</startElementReference>
    <variables>
        <name>CartApp</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Cart_Application__c</objectType>
    </variables>
    <variables>
        <name>connectedAppId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>CustomerSupportQueue</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <value>
            <stringValue>CustomerSupportQueue</stringValue>
        </value>
    </variables>
    <variables>
        <name>Details</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>ExternalEmail</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>ExternalFirstName</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>ExternalLastName</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>ExternalUserId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>ExternalUsername</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>NeedsManualProvisioning</name>
        <dataType>Boolean</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <value>
            <booleanValue>false</booleanValue>
        </value>
    </variables>
    <variables>
        <name>needToSendEmail</name>
        <dataType>Boolean</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
        <value>
            <booleanValue>false</booleanValue>
        </value>
    </variables>
    <variables>
        <name>nextReconOffset</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>ProvisioningRTType</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>queueId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>reconOffset</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>reconState</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>Status</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>targetApp</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Application__c</objectType>
    </variables>
    <variables>
        <name>UPROwnerID</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>User</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
        <objectType>User</objectType>
    </variables>
    <variables>
        <name>UserID</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>UserProvAccount</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
        <objectType>UserProvAccount</objectType>
    </variables>
    <variables>
        <name>UserProvisioningRequest</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
        <objectType>UserProvisioningRequest</objectType>
    </variables>
</Flow>
